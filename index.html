<!DOCTYPE html>
<html lang="vi">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
Â  Â  <title>Váº­n HÃ nh LÆ°á»›i Äiá»‡n - Mobile v1.21</title>
Â  Â Â 
Â  Â  <link rel="manifest" href="manifest.json">
Â  Â  <meta name="theme-color" content="#004d40">
Â  Â  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1165/1165187.png">
Â  Â  <meta name="apple-mobile-web-app-capable" content="yes">
Â  Â Â 
Â  Â  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
Â  Â Â 
Â  Â  <style>
Â  Â  Â  Â  /* --- CORE CSS --- */
Â  Â  Â  Â  html, body { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #f0f2f5; }
Â  Â  Â  Â  #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; z-index: 1; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* LOGIN SCREEN */
Â  Â  Â  Â  #login-screen {
Â  Â  Â  Â  Â  Â  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
Â  Â  Â  Â  Â  Â  background: #004d40; z-index: 9999; display: flex; flex-direction: column;
Â  Â  Â  Â  Â  Â  justify-content: center; align-items: center; color: white;
Â  Â  Â  Â  Â  Â  transition: top 0.5s ease-in-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .login-box { text-align: center; width: 80%; max-width: 300px; }
Â  Â  Â  Â  .login-btn {
Â  Â  Â  Â  Â  Â  background: white; color: #333; border: none; padding: 12px 20px;
Â  Â  Â  Â  Â  Â  border-radius: 25px; font-weight: bold; margin-top: 20px; cursor: pointer;
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* APP UI */
Â  Â  Â  Â  .app-bar { position: absolute; top: 10px; left: 10px; right: 10px; height: 50px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 2000; display: flex; align-items: center; padding: 0 10px; justify-content: space-between; }
Â  Â  Â  Â  .app-title { font-weight: bold; color: #004d40; font-size: 1rem; }
Â  Â  Â  Â  .btn-menu { border: none; background: none; font-size: 1.2rem; color: #333; padding: 10px; cursor: pointer; }

Â  Â  Â  Â  #control-panel { position: fixed; bottom: -100%; left: 0; width: 100%; background: white; z-index: 3000; border-top-left-radius: 15px; border-top-right-radius: 15px; box-shadow: 0 -2px 20px rgba(0,0,0,0.3); transition: bottom 0.3s ease-in-out; max-height: 85%; overflow-y: auto; padding-bottom: 20px; }
Â  Â  Â  Â  #control-panel.active { bottom: 0; }
Â  Â  Â  Â  .panel-header { padding: 15px; background: #004d40; color: white; border-top-left-radius: 15px; border-top-right-radius: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
Â  Â  Â  Â  .panel-body { padding: 15px; }

Â  Â  Â  Â  label { font-weight: 600; font-size: 0.9rem; display: block; margin: 10px 0 5px; color: #555; }
Â  Â  Â  Â  select, input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
Â  Â  Â  Â  button.action-btn { padding: 12px; width: 100%; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.2s; color: white; font-size: 1rem; display: flex; justify-content: center; align-items: center; gap: 8px; }
Â  Â  Â  Â  .btn-find { background: #d32f2f; }
Â  Â  Â  Â  .btn-ground { background: #0288d1; }
Â  Â  Â  Â  .btn-gps { position: absolute; top: 70px; right: 10px; z-index: 2000; background: white; width: 40px; height: 40px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: none; font-size: 1.2rem; color: #555; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: color 0.3s; }
Â  Â  Â  Â  .btn-gps.active { color: #0078d7; border: 2px solid #0078d7; }Â 
Â  Â  Â  Â  .btn-gps.manual { color: #e65100; border: 2px solid #e65100; }

Â  Â  Â  Â  /* GUIDE BUTTON */
Â  Â  Â  Â  .btn-guide {Â 
Â  Â  Â  Â  Â  Â  position: absolute; top: 120px; right: 10px; z-index: 2000;Â 
Â  Â  Â  Â  Â  Â  background: white; width: 40px; height: 40px; border-radius: 50%;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: none;Â 
Â  Â  Â  Â  Â  Â  font-size: 1.2rem; color: #004d40;Â 
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; justify-content: center;Â 
Â  Â  Â  Â  Â  Â  cursor: pointer; text-decoration: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  .radio-group { display: flex; flex-direction: row; align-items: center; gap: 30px; margin-bottom: 15px; width: 100%; }
Â  Â  Â  Â  .radio-group label { margin: 0; font-weight: normal; cursor: pointer; display: flex; align-items: center; font-size: 1rem; }
Â  Â  Â  Â  .radio-group input { width: 20px; height: 20px; margin-right: 8px; }

Â  Â  Â  Â  #custom-confirm { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
Â  Â  Â  Â  .win-dialog { background: #f0f0f0; width: 90%; max-width: 400px; border-radius: 4px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.4); animation: popIn 0.2s ease-out; }
Â  Â  Â  Â  .win-body { padding: 20px; text-align: center; }
Â  Â  Â  Â  .win-footer { padding: 10px; background: #f5f5f5; display: flex; gap: 10px; }
Â  Â  Â  Â  .win-btn { flex: 1; padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
Â  Â  Â  Â  .btn-yes { background: #0078d7; color: white; }
Â  Â  Â  Â  .btn-no { background: #ddd; color: #333; }

Â  Â  Â  Â  /* FAULT BOX */
Â  Â  Â  Â  .fault-box { display: none; background: white; padding: 0; border-radius: 8px; box-shadow: 0 0 20px rgba(255, 0, 0, 0.4); border-left: 5px solid #d32f2f; width: 90%; max-width: 350px; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 4000; font-size: 0.9rem; max-height: 75vh; flex-direction: column; transition: all 0.3s; }
Â  Â  Â  Â  .fault-box.minimized { height: 45px; overflow: hidden; }
Â  Â  Â  Â  .fault-header { padding: 10px 15px; background: #ffebee; color: #d32f2f; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ffcdd2; height: 25px; flex-shrink: 0; }
Â  Â  Â  Â  .fault-body { padding: 15px; overflow-y: auto; flex: 1; background: white; }
Â  Â  Â  Â  .header-actions { display: flex; gap: 10px; }
Â  Â  Â  Â  .header-btn { border: none; background: none; cursor: pointer; font-size: 1rem; color: #d32f2f; padding: 2px 5px; }

Â  Â  Â  Â  /* NEW TEXT FORMAT */
Â  Â  Â  Â  .fault-text-block { line-height: 1.6; margin-bottom: 10px; border-bottom: 1px dashed #ccc; padding-bottom: 10px; color: #333; }
Â  Â  Â  Â  .ft-highlight { font-weight: bold; color: #004d40; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .route-info-box { background: #fff3e0; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #ffb74d; color: #e65100; font-weight: bold; display: none; align-items: center; gap: 10px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .weather-info { background: #e3f2fd; padding: 8px; border-radius: 4px; margin-top: 5px; font-size: 0.85rem; border: 1px solid #90caf9; display: none; }
Â  Â  Â  Â  .weather-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
Â  Â  Â  Â  .weather-alert { color: #d32f2f; font-weight: bold; margin-top: 4px; border-top: 1px dashed #d32f2f; padding-top: 4px; display: flex; align-items: center; gap: 5px; }
Â  Â  Â  Â  .weather-flood { color: #0d47a1; font-weight: bold; margin-top: 4px; border-top: 1px dashed #0d47a1; padding-top: 4px; display: flex; align-items: center; gap: 5px; }

Â  Â  Â  Â  /* ICONS */
Â  Â  Â  Â  .my-icon { border: 1px solid white; box-shadow: 1px 1px 3px rgba(0,0,0,0.6); text-align: center; font-size: 9px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; }
Â  Â  Â  Â  .icon-tru-do { background: #1976d2; border-radius: 50%; border: 2px solid white; }
Â  Â  Â  Â  .icon-tru-neo { background: #1976d2; border-radius: 2px; border: 2px solid white; }
Â  Â  Â  Â  .icon-mc-base { border: 2px solid white; border-radius: 2px; z-index: 1000; }
Â  Â  Â  Â  .icon-mc-source { border: 2px solid #ffeb3b !important; box-shadow: 0 0 5px #ffeb3b; z-index: 1001 !important; }
Â  Â  Â  Â  .fault-marker { font-size: 40px; color: #d32f2f; text-shadow: 0 0 10px #ffeb3b; animation: flash 0.5s infinite alternate; }
Â  Â  Â  Â  @keyframes flash { from { opacity: 1; transform: scale(1); } to { opacity: 0.5; transform: scale(1.2); } }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .warning-msg { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 4px; border: 1px solid #ffcdd2; margin-top: 10px; display: none; font-weight: bold; text-align: center; }
Â  Â  Â  Â  .legend { background: rgba(255,255,255,0.9); padding: 5px 8px; border-radius: 4px; font-size: 0.7rem; display: block; margin-bottom: 50px !important; }
Â  Â  Â  Â  .legend-item { display: flex; align-items: center; margin-bottom: 2px; }
Â  Â  Â  Â  .legend-icon { width: 12px; height: 12px; margin-right: 5px; display: inline-block; border: 1px solid #999; }
Â  Â  </style>
</head>
<body>

Â  Â  <div id="login-screen">
Â  Â  Â  Â  <div class="login-box">
Â  Â  Â  Â  Â  Â  <h2 style="margin-bottom:10px;">Váº¬N HÃ€NH LÆ¯á»šI ÄIá»†N</h2>
Â  Â  Â  Â  Â  Â  <p style="font-size:0.9rem; opacity:0.8; margin-bottom:30px;">Há»‡ thá»‘ng thÃ´ng tin sá»± cá»‘ & báº£n Ä‘á»“</p>
Â  Â  Â  Â  Â  Â  <button class="login-btn" onclick="signIn()"><i class="fab fa-google"></i> ÄÄƒng nháº­p báº±ng Google</button>
Â  Â  Â  Â  Â  Â  <p id="login-status" style="margin-top:15px; font-size:0.8rem;"></p>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="map"></div>
Â  Â  <div id="pick-notice" style="position:fixed;top:70px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:white;padding:8px 15px;border-radius:20px;z-index:5000;font-size:0.9rem;display:none;box-shadow:0 4px 10px rgba(0,0,0,0.3);pointer-events:none;">ğŸ‘‡ Cháº¥m vÃ o báº£n Ä‘á»“ Ä‘á»ƒ chá»n vá»‹ trÃ­ cá»§a báº¡n</div>
Â  Â Â 
Â  Â  <div class="app-bar">
Â  Â  Â  Â  <div class="app-title">âš¡ Váº¬N HÃ€NH LÆ¯á»šI ÄIá»†N v1.21</div>
Â  Â  Â  Â  <button class="btn-menu" onclick="togglePanel()"><i class="fas fa-bars"></i></button>
Â  Â  </div>

Â  Â  <button class="btn-gps" id="btn-gps" onclick="handleGpsClick()"><i class="fas fa-crosshairs"></i></button>

Â  Â  <a href="https://trancongdep.github.io/tracuusuco/huongdan.html" target="_blank" class="btn-guide" title="HÆ°á»›ng dáº«n sá»­ dá»¥ng">
Â  Â  Â  Â  <i class="fas fa-book"></i>
Â  Â  </a>

Â  Â  <div id="control-panel">
Â  Â  Â  Â  <div class="panel-header">
Â  Â  Â  Â  Â  Â  <span>TÃŒM KIáº¾M & ÄIá»€U KHIá»‚N</span>
Â  Â  Â  Â  Â  Â  <span onclick="togglePanel()" style="cursor:pointer;font-size:1.5rem;">Ã—</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="panel-body">
Â  Â  Â  Â  Â  Â  <label>Chá»n Máº¡ch:</label>
Â  Â  Â  Â  Â  Â  <select id="circuitSelect" onchange="window.zoomToCircuit()"><option value="">-- ToÃ n cáº£nh --</option></select>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 6px;">
Â  Â  Â  Â  Â  Â  Â  Â  Tráº¡ng thÃ¡i: <span id="status-text" style="font-weight:bold;">---</span>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="circuit-info" style="font-size:0.85rem; color:#00695c; margin-top:5px;"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button class="action-btn btn-ground" id="btn-grounding" onclick="toggleGrounding()" style="display:none;">ğŸ”’ ÄÃ“NG TIáº¾P Äá»ŠA</button>

Â  Â  Â  Â  Â  Â  <div style="border-top:1px dashed #ccc; margin:15px 0;"></div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <label>Thá»i Ä‘iá»ƒm sá»± cá»‘:</label>
Â  Â  Â  Â  Â  Â  <input type="datetime-local" id="incidentTime" />

Â  Â  Â  Â  Â  Â  <label>Nháº­p khoáº£ng cÃ¡ch sá»± cá»‘ (Km):</label>
Â  Â  Â  Â  Â  Â  <input type="number" id="faultKm" step="0.01" placeholder="VÃ­ dá»¥: 3.5" />
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="radio-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label><input type="radio" name="faultDir" value="start" checked> Tá»« Äáº§u</label>
Â  Â  Â  Â  Â  Â  Â  Â  <label><input type="radio" name="faultDir" value="end"> Tá»« Cuá»‘i</label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button class="action-btn btn-find" id="btn-find-fault" onclick="window.findFault()">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-search-location"></i> TÃŒM Vá»Š TRÃ
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <div id="result" class="warning-msg"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="custom-confirm">
Â  Â  Â  Â  <div class="win-dialog">
Â  Â  Â  Â  Â  Â  <div class="win-body">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-question-circle" style="font-size:3rem;color:#0078d7;margin-bottom:10px;"></i>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="win-msg" style="font-size:1.1rem;">...</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="win-footer">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="win-btn btn-yes" id="win-btn-yes" onclick="window.confirmAction()">Äá»“ng Ã½</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="win-btn btn-no" onclick="closeWinDialog()">Há»§y</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
Â  Â  <script src="https://unpkg.com/leaflet-polylineoffset@1.1.1/leaflet.polylineoffset.js"></script>
Â  Â  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
Â  Â Â 
Â  Â  <script type="module">
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
Â  Â  Â  Â  import { getDatabase, ref, update, onValue, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
Â  Â  Â  Â  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

Â  Â  Â  Â  const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  const auth = getAuth(app);
Â  Â  Â  Â  const provider = new GoogleAuthProvider();

Â  Â  Â  Â  // FIX: Export missing functions to window
Â  Â  Â  Â  window.db = getDatabase(app);Â 
Â  Â  Â  Â  window.update = update;Â 
Â  Â  Â  Â  window.ref = ref;Â 
Â  Â  Â  Â  window.onValue = onValue;Â 
Â  Â  Â  Â  window.set = set; // Critical for saving logs
Â  Â  Â  Â  window.get = get; // Critical for checking user
Â  Â  Â  Â  window.child = child;
Â  Â  Â  Â Â 
Â  Â  Â  Â  window.signIn = () => {
Â  Â  Â  Â  Â  Â  signInWithPopup(auth, provider).catch((error) => {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('login-status').innerText = "Lá»—i Ä‘Äƒng nháº­p: " + error.message;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };

Â  Â  Â  Â  onAuthStateChanged(auth, (user) => {
Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  checkAndSaveUser(user);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('login-screen').style.top = '0';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  async function checkAndSaveUser(user) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const userRef = window.ref(window.db, 'users/' + user.uid);
Â  Â  Â  Â  Â  Â  Â  Â  let snapshot = await window.get(userRef);
Â  Â  Â  Â  Â  Â  Â  Â  let userData = snapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let phoneNumber = "";
Â  Â  Â  Â  Â  Â  Â  Â  if (userData && userData.phone) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  phoneNumber = userData.phone;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let p = prompt("Vui lÃ²ng nháº­p Sá»‘ Ä‘iá»‡n thoáº¡i cá»§a báº¡n Ä‘á»ƒ xÃ¡c nháº­n (Báº¯t buá»™c):");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(p) phoneNumber = p;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else phoneNumber = "KhÃ´ng cung cáº¥p";
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  let nowStr = new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â  Â  const logRef = window.ref(window.db, 'system_logs/logins/' + Date.now());
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // SAVE LOG (Fix applied here)
Â  Â  Â  Â  Â  Â  Â  Â  await window.set(logRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uid: user.uid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: user.displayName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  email: user.email,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  phone: phoneNumber,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  time: nowStr
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // UPDATE PROFILE
Â  Â  Â  Â  Â  Â  Â  Â  await window.update(userRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: user.displayName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  email: user.email,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  phone: phoneNumber,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  last_login: nowStr
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('login-screen').style.top = '-100%';
Â  Â  Â  Â  Â  Â  Â  Â  window.listenCloud();
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Login Error:", e);
Â  Â  Â  Â  Â  Â  Â  Â  alert("Lá»—i lÆ°u dá»¯ liá»‡u Ä‘Äƒng nháº­p: " + e.message + ". Vui lÃ²ng kiá»ƒm tra Rules trÃªn Firebase.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </script>

Â  Â  <script>
Â  Â  Â  Â  let map = L.map('map', { zoomControl: false, maxZoom: 22 }).setView([10.762, 106.660], 12);
Â  Â  Â  Â  L.control.zoom({ position: 'topright' }).addTo(map);
Â  Â  Â  Â  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri', maxNativeZoom: 19, maxZoom: 22 }).addTo(map);
Â  Â  Â  Â  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { opacity:0.4, maxNativeZoom: 19, maxZoom: 22 }).addTo(map);
Â  Â  Â  Â Â 
Â  Â  Â  Â  map.createPane('areaPane'); map.getPane('areaPane').style.zIndex = 200;
Â  Â  Â  Â  let layers = { areas: L.layerGroup().addTo(map), main: L.layerGroup().addTo(map), minor: L.layerGroup().addTo(map), important: L.layerGroup().addTo(map), mc: L.layerGroup().addTo(map), fault: L.layerGroup().addTo(map), editHighlight: L.layerGroup().addTo(map) };
Â  Â  Â  Â  layers.fault.setZIndex(9999);
Â  Â  Â  Â Â 
Â  Â  Â  Â  let appData = { poles: {}, segments: {}, circuits: {}, mcStates: {}, grounded: {}, areas: [] };Â 
Â  Â  Â  Â  window.pendingAction = null; let currentPath = []; let currentPathTotalDist = 0; let pickingMode = null; let tempAreaPoints = []; let tempAreaPoly = null;
Â  Â  Â  Â  let currentEditingCircuit = []; let userLocation = null; let isPickingUserLocation = false;
Â  Â  Â  Â Â 
Â  Â  Â  Â  function setNowToInput() {
Â  Â  Â  Â  Â  Â  const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
Â  Â  Â  Â  Â  Â  document.getElementById('incidentTime').value = now.toISOString().slice(0,16);
Â  Â  Â  Â  }
Â  Â  Â  Â  setNowToInput();

Â  Â  Â  Â  map.locate({setView: false, maxZoom: 16});

Â  Â  Â  Â  function togglePanel() { document.getElementById('control-panel').classList.toggle('active'); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  window.handleGpsClick = function() {
Â  Â  Â  Â  Â  Â  if(isPickingUserLocation) {
Â  Â  Â  Â  Â  Â  Â  Â  isPickingUserLocation = false;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('pick-notice').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('btn-gps').style.color = '#555';
Â  Â  Â  Â  Â  Â  map.locate({setView: true, maxZoom: 16});
Â  Â  Â  Â  }

Â  Â  Â  Â  map.on('locationfound', function(e) {Â 
Â  Â  Â  Â  Â  Â  setUserLocation(e.latlng);
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  map.on('locationerror', function(e) {
Â  Â  Â  Â  Â  Â  let btn = document.getElementById('btn-gps');
Â  Â  Â  Â  Â  Â  btn.classList.remove('active');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(confirm("âš ï¸ KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­ GPS tá»± Ä‘á»™ng (do lá»—i trÃ¬nh duyá»‡t hoáº·c chÆ°a cáº¥p quyá»n).\n\nBáº¡n cÃ³ muá»‘n CHáº¤M TAY vá»‹ trÃ­ cá»§a báº¡n trÃªn báº£n Ä‘á»“ khÃ´ng?")) {
Â  Â  Â  Â  Â  Â  Â  Â  enableManualPick();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  function enableManualPick() {
Â  Â  Â  Â  Â  Â  isPickingUserLocation = true;
Â  Â  Â  Â  Â  Â  togglePanel();Â 
Â  Â  Â  Â  Â  Â  document.getElementById('pick-notice').style.display = 'block';
Â  Â  Â  Â  Â  Â  document.getElementById('btn-gps').classList.add('manual');Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function setUserLocation(latlng) {
Â  Â  Â  Â  Â  Â  userLocation = latlng;
Â  Â  Â  Â  Â  Â  map.eachLayer(layer => { if(layer.options.id === 'user_marker') map.removeLayer(layer); });

Â  Â  Â  Â  Â  Â  L.circleMarker(latlng, {id: 'user_marker', radius:8, color:'white', fillColor:'#0078d7', fillOpacity:1, weight: 2}).addTo(map)
Â  Â  Â  Â  Â  Â  Â .bindPopup("Vá»‹ trÃ­ cá»§a báº¡n").openPopup();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let btn = document.getElementById('btn-gps');
Â  Â  Â  Â  Â  Â  btn.classList.add('active'); btn.classList.remove('manual');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  isPickingUserLocation = false;
Â  Â  Â  Â  Â  Â  document.getElementById('pick-notice').style.display = 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  map.on('click', function(e) {Â 
Â  Â  Â  Â  Â  Â  if(isPickingUserLocation) {
Â  Â  Â  Â  Â  Â  Â  Â  setUserLocation(e.latlng);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  function updateLayerVisibility() { let z = map.getZoom(); if (z < 15) { if(map.hasLayer(layers.minor)) map.removeLayer(layers.minor); if(map.hasLayer(layers.mc)) map.removeLayer(layers.mc); } else { if(!map.hasLayer(layers.minor)) map.addLayer(layers.minor); if(!map.hasLayer(layers.mc)) map.addLayer(layers.mc); } }
Â  Â  Â  Â  map.on('zoomend', updateLayerVisibility);

Â  Â  Â  Â  window.listenCloud = function() { window.onValue(window.ref(window.db, 'he_thong_luoi_dien'), snap => { let val = snap.val(); if(val) { appData = val; if(!appData.mcStates) appData.mcStates={}; if(!appData.grounded) appData.grounded={}; updateUI(); calculateOffsets(); renderGlobalMap(); if(document.getElementById('circuitSelect').value) window.zoomToCircuit(); } }); }
Â  Â  Â  Â  function updateUI() { const s = document.getElementById('circuitSelect'); let cur = s.value; s.innerHTML = '<option value="">-- ToÃ n cáº£nh --</option>'; if(appData.circuits) Object.keys(appData.circuits).forEach(k => { let o=document.createElement('option'); o.value=k; o.text=k; s.add(o); }); s.value = cur; }

Â  Â  Â  Â  function createIcon(type, name, isClosed, sourceVoltage) {
Â  Â  Â  Â  Â  Â  let cls = 'my-icon icon-tru-do', sz = [12,12], label = '';
Â  Â  Â  Â  Â  Â  if (type.includes('MC')) { cls = isClosed ? 'my-icon icon-mc-base icon-mc-on' : 'my-icon icon-mc-base icon-mc-off'; sz = [22, 16]; if (sourceVoltage && sourceVoltage.length > 0) { cls += ' icon-mc-source'; sz = [26, 20]; } let parts = name.split('_'); label = parts.length > 1 ? parts[parts.length-1] : name; }Â 
Â  Â  Â  Â  Â  Â  else if (type.includes('NEO')) cls = 'my-icon icon-tru-neo'; else if (type.includes('MOC')) { cls = 'my-icon icon-moc'; sz = [8,8]; }
Â  Â  Â  Â  Â  Â  return L.divIcon({ className: cls, html: label, iconSize: sz });
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderGlobalMap() {
Â  Â  Â  Â  Â  Â  layers.main.clearLayers(); layers.minor.clearLayers(); layers.important.clearLayers(); layers.mc.clearLayers(); layers.areas.clearLayers();
Â  Â  Â  Â  Â  Â  updateLayerVisibility();
Â  Â  Â  Â  Â  Â  if(appData.areas) appData.areas.forEach(a => { let c='#9e9e9e'; if(a.type==='TBA') c='#ff9800'; else if(a.type==='CONSTRUCTION') c='#ffeb3b'; else if(a.type==='FOUNDATION') c='#795548'; L.polygon(a.points, {color:c, fillColor:c, fillOpacity:0.3, weight:1}).addTo(layers.areas).bindPopup(`<b>${a.name}</b><br>${a.type}`); });
Â  Â  Â  Â  Â  Â  if(appData.poles) for(let l in appData.poles) appData.poles[l].forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  let isMC = p.type.includes('MC'), isMinor = p.type === 'TRU_DO' || p.type === 'MOC'; let target = isMC ? layers.mc : (isMinor ? layers.minor : layers.important);
Â  Â  Â  Â  Â  Â  Â  Â  let isClosed = isMC ? (appData.mcStates[p.name] !== false) : true;
Â  Â  Â  Â  Â  Â  Â  Â  let marker = L.marker([p.lat, p.lng], { icon: createIcon(p.type, p.name, isClosed, p.sourceVoltage), zIndexOffset: isMC ? 1000 : 0 }).addTo(target);
Â  Â  Â  Â  Â  Â  Â  Â  if (isMC) { marker.on('click', () => { let currentState = appData.mcStates[p.name] !== false; document.getElementById('win-msg').innerHTML = `Äiá»u khiá»ƒn mÃ¡y cáº¯t <b>${p.name}</b>?<br><br>Tráº¡ng thÃ¡i: <b>${currentState?"ÄANG ÄÃ“NG":"ÄANG Má»"}</b>`; window.pendingAction = { type: 'mc', name: p.name }; document.getElementById('custom-confirm').style.display = 'flex'; }); } else { marker.bindPopup(`<b>${p.name}</b><br>${l}`); }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if(appData.circuits) Object.keys(appData.circuits).forEach(cid => drawSingleCircuit(cid, false));
Â  Â  Â  Â  }

Â  Â  Â  Â  function drawSingleCircuit(circuitId, calcPath, excludeSegId, simulationOnly = false) {
Â  Â  Â  Â  Â  Â  const segs = appData.circuits[circuitId]; if(!segs) return;
Â  Â  Â  Â  Â  Â  let connectedMCs = []; segs.forEach(item => { let def = appData.segments[item.segId]; if(def) { let p1 = getPoleExact(def.lineFrom, def.poleFrom), p2 = getPoleExact(def.lineTo, def.poleTo); if(p1 && p1.type.includes('MC')) connectedMCs.push(p1); if(p2 && p2.type.includes('MC')) connectedMCs.push(p2); } });
Â  Â  Â  Â  Â  Â  let activeVoltage = null; let isGrounded = appData.grounded ? appData.grounded[circuitId] : false;
Â  Â  Â  Â  Â  Â  let activeSources = connectedMCs.filter(mc => (appData.mcStates[mc.name] !== false) && mc.sourceVoltage);
Â  Â  Â  Â  Â  Â  if (activeSources.length > 0) { activeSources.sort((a,b) => { let vA = parseInt(a.sourceVoltage)||0, vB = parseInt(b.sourceVoltage)||0; return vB - vA; }); activeVoltage = activeSources[0].sourceVoltage; }
Â  Â  Â  Â  Â  Â  let color = '#000000', statusText = "Máº¤T ÄIá»†N";
Â  Â  Â  Â  Â  Â  if (isGrounded) { color = '#2196f3'; statusText = "ÄANG TIáº¾P Äá»ŠA"; } else if (activeVoltage) { if (activeVoltage.includes('110')) { color = '#388e3c'; statusText = "CÃ“ ÄIá»†N (110kV)"; } else if (activeVoltage.includes('220')) { color = '#d32f2f'; statusText = "CÃ“ ÄIá»†N (220kV)"; } else if (activeVoltage.includes('500')) { color = '#0d47a1'; statusText = "CÃ“ ÄIá»†N (500kV)"; } }
Â  Â  Â  Â  Â  Â  if(calcPath) { if(!simulationOnly) { document.getElementById('status-text').innerHTML = `<span style="color:${color}">${statusText}</span>`; let btnG = document.getElementById('btn-grounding'); if(!activeVoltage || isGrounded) { btnG.style.display = 'flex'; btnG.innerHTML = isGrounded ? "<i class='fas fa-lock-open'></i> Má» TIáº¾P Äá»ŠA" : "<i class='fas fa-lock'></i> ÄÃ“NG TIáº¾P Äá»ŠA"; btnG.style.background = isGrounded ? "#7cb342" : "#0288d1"; } else { btnG.style.display = 'none'; } } currentPath=[]; currentPathTotalDist=0; }
Â  Â  Â  Â  Â  Â  segs.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  let def = appData.segments[item.segId]; if(!def) return; let pts = getPointsForSegment(def);Â 
Â  Â  Â  Â  Â  Â  Â  Â  let p1=getPoleExact(def.lineFrom, def.poleFrom)||getPoleGlobal(def.poleFrom), p2=getPoleExact(def.lineTo, def.poleTo)||getPoleGlobal(def.poleTo);
Â  Â  Â  Â  Â  Â  Â  Â  let offset = 0;
Â  Â  Â  Â  Â  Â  Â  Â  if(p1 && p2 && !simulationOnly) { let key = getSegmentKey(p1, p2); let list = segmentCounts[key]; if (list && list.length > 1) { let idx = list.indexOf(circuitId); if (idx !== -1) { let center = (list.length - 1) / 2; offset = (idx - center) * 6; } } }
Â  Â  Â  Â  Â  Â  Â  Â  if(pts.length) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!simulationOnly) { let isCable=def.type.includes("NGAM"); L.polyline(pts.map(p=>[p.lat,p.lng]), { color: color, weight: calcPath?5:3, opacity: calcPath?1:0.8, dashArray: isCable?"5,5":null, offset: offset }).addTo(layers.main).bindPopup(`<b>${circuitId}</b><br>${statusText}`); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(calcPath) pts.forEach((p,i)=>{ if(i>0) currentPathTotalDist+=getDist(pts[i-1].lat,pts[i-1].lng,p.lat,p.lng); currentPath.push({lat: p.lat, lng: p.lng, accDist:currentPathTotalDist, name: p.name}); });Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  let segmentCounts = {};
Â  Â  Â  Â  function getSegmentKey(p1, p2) { let k1=p1.lat+"_"+p1.lng, k2=p2.lat+"_"+p2.lng; return (k1<k2)?(k1+"|"+k2):(k2+"|"+k1); }
Â  Â  Â  Â  function calculateOffsets() { segmentCounts={}; if(appData.circuits) Object.keys(appData.circuits).forEach(cid=>{ appData.circuits[cid].forEach(item=>{ let def=appData.segments[item.segId]; if(def){ let p1=getPoleExact(def.lineFrom,def.poleFrom), p2=getPoleExact(def.lineTo,def.poleTo); if(p1&&p2){ let k=getSegmentKey(p1,p2); if(!segmentCounts[k]) segmentCounts[k]=[]; segmentCounts[k].push(cid); } } }); }); }
Â  Â  Â  Â  function getPoleExact(line, name) { if(!appData.poles[line]) return null; return appData.poles[line].find(p=>String(p.name).toUpperCase()===String(name).toUpperCase()); }
Â  Â  Â  Â  function getPoleGlobal(name) { for(let l in appData.poles) { let p=appData.poles[l].find(p=>String(p.name).toUpperCase()===String(name).toUpperCase()); if(p) return {...p, foundRoute:l}; } return null; }
Â  Â  Â  Â  function getDist(lat1,lon1,lat2,lon2) { const R=6371000, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
Â  Â  Â  Â  function getPointsForSegment(seg) {
Â  Â  Â  Â  Â  Â  if(!seg) return [];
Â  Â  Â  Â  Â  Â  let p1 = getPoleExact(seg.lineFrom, seg.poleFrom) || getPoleGlobal(seg.poleFrom);
Â  Â  Â  Â  Â  Â  let p2 = getPoleExact(seg.lineTo, seg.poleTo) || getPoleGlobal(seg.poleTo);
Â  Â  Â  Â  Â  Â  if(!p1 || !p2) return [];
Â  Â  Â  Â  Â  Â  let r1 = p1.foundRoute || seg.lineFrom; let r2 = p2.foundRoute || seg.lineTo;
Â  Â  Â  Â  Â  Â  if (r1 === r2) {
Â  Â  Â  Â  Â  Â  Â  Â  let routePoles = appData.poles[r1];
Â  Â  Â  Â  Â  Â  Â  Â  if (routePoles) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let i1 = routePoles.findIndex(p => p.name === p1.name);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let i2 = routePoles.findIndex(p => p.name === p2.name);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (i1 !== -1 && i2 !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let segmentPoles = (i1 <= i2) ? routePoles.slice(i1, i2 + 1) : routePoles.slice(i2, i1 + 1).reverse();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return segmentPoles.map(p => ({lat: p.lat, lng: p.lng, name: p.name}));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return [{lat: p1.lat, lng: p1.lng, name: p1.name}, {lat: p2.lat, lng: p2.lng, name: p2.name}];
Â  Â  Â  Â  }

Â  Â  Â  Â  window.zoomToCircuit = function() { let id = document.getElementById('circuitSelect').value; layers.main.clearLayers(); renderGlobalMap(); document.getElementById('btn-grounding').style.display = 'none'; if(!id) { document.getElementById('status-text').innerText = "---"; return; } drawSingleCircuit(id, true); document.getElementById('circuit-info').innerText = `Tá»•ng dÃ i: ${(currentPathTotalDist/1000).toFixed(3)} km`; if(currentPath.length) map.fitBounds(currentPath.map(p=>[p.lat,p.lng])); }

Â  Â  Â  Â  window.findFault = function() {Â 
Â  Â  Â  Â  Â  Â  let btn = document.getElementById('btn-find-fault');
Â  Â  Â  Â  Â  Â  let oldText = btn.innerHTML;
Â  Â  Â  Â  Â  Â  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Äang tÃ­nh toÃ¡n...'; btn.disabled = true;

Â  Â  Â  Â  Â  Â  if (!userLocation) { map.locate({setView: false, maxZoom: 16}); }

Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  layers.fault.clearLayers();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let res = document.getElementById('result'); res.style.display='none';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let faultBox = document.getElementById('fault-info-box'); if(faultBox) faultBox.style.display='none';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let timeVal = document.getElementById('incidentTime').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let timeStr = timeVal ? timeVal.replace('T', ' ') : "N/A";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let kmInput = parseFloat(document.getElementById('faultKm').value);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let direction = document.querySelector('input[name="faultDir"]:checked').value;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let dirText = direction === 'start' ? "Ä‘áº§u nguá»“n" : "cuá»‘i nguá»“n";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let cName = document.getElementById('circuitSelect').value;Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentPath = [];Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(cName) drawSingleCircuit(cName, true, null, true);Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(isNaN(kmInput) || currentPath.length<2) { res.style.display='block'; res.className='warning-msg'; res.innerText='Vui lÃ²ng chá»n máº¡ch trÆ°á»›c!'; btn.innerHTML = oldText; btn.disabled = false; return; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let totalKm = currentPathTotalDist / 1000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(kmInput > totalKm) { res.style.display='block'; res.className='warning-msg'; res.innerText=`âš ï¸ Km nháº­p (${kmInput}) > Chiá»u dÃ i máº¡ch (${totalKm.toFixed(3)} km)!`; btn.innerHTML = oldText; btn.disabled = false; return; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let targetDist = direction==='end' ? currentPathTotalDist-(kmInput*1000) : kmInput*1000;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let found = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(let i=1; i<currentPath.length; i++) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let p1=currentPath[i-1], p2=currentPath[i]; let d1=p1.accDist, d2=p2.accDist;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(targetDist>=(d1-0.1) && targetDist<=(d2+0.1)) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  found = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let ratio = (d2 > d1) ? (targetDist-d1)/(d2-d1) : 0;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let lat = p1.lat + (p2.lat-p1.lat)*ratio, lng = p1.lng + (p2.lng-p1.lng)*ratio;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let n1 = "Äiá»ƒm Ä‘áº§u", n2 = "Äiá»ƒm cuá»‘i";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let j = i-1; j >= 0; j--) { if (currentPath[j].name) { n1 = currentPath[j].name; break; } }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let j = i; j < currentPath.length; j++) { if (currentPath[j].name) { n2 = currentPath[j].name; break; } }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(faultBox) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  faultBox.style.display='block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  faultBox.classList.remove('minimized');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let infoText = `LÃºc ${timeStr}, báº­t Ä‘Æ°á»ng dÃ¢y ${cName}, cÃ¡ch ${dirText}: ${kmInput} km, vá»‹ trÃ­ dá»± kiáº¿n: khoáº£ng trá»¥ ${n1} - ${n2}.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('fi-text-content').innerHTML = infoText;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('fi-addr').innerHTML=`<a href="http://googleusercontent.com/maps.google.com/maps?q=${lat},${lng}" target="_blank">Má»Ÿ Google Maps</a>`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('fi-addr-text').innerText = 'â³ Äang láº¥y...';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('route-info').innerHTML = '<i>â³ Äang tÃ­nh lá»™ trÃ¬nh...</i>'; document.getElementById('route-info').style.display='flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('fault-weather').innerHTML = '<i>â³ Äang táº£i thá»i tiáº¿t...</i>'; document.getElementById('fault-weather').style.display='block';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fetchWeather(lat, lng, timeVal);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fetchAddress(lat, lng);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(userLocation) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fetchRoute(userLocation.lat, userLocation.lng, lat, lng, 'driving')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(success => { if(!success) return fetchRoute(userLocation.lat, userLocation.lng, lat, lng, 'walking'); })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(success => { if(success === false) { let d = getDist(userLocation.lat, userLocation.lng, lat, lng) / 1000; document.getElementById('route-info').innerHTML = `<div><i class="fas fa-plane"></i> <b>${d.toFixed(1)} km</b> (Chim bay)</div>`; }});
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else { document.getElementById('route-info').innerHTML = '<span style="color:red">ChÆ°a láº¥y Ä‘Æ°á»£c vá»‹ trÃ­ GPS.</span>'; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  L.marker([lat,lng], { zIndexOffset: 9999, icon: L.divIcon({ html:'<i class="fas fa-bolt fault-marker"></i>', className:'d', iconSize: [30, 30], iconAnchor: [15, 30] }) }).addTo(layers.fault).bindPopup("<b>Sá»° Cá» Táº I ÄÃ‚Y</b>").openPopup();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.setView([lat, lng], 18); togglePanel(); break;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!found) { res.style.display='block'; res.className='warning-msg'; res.innerText = `KhÃ´ng tÃ¬m tháº¥y Ä‘iá»ƒm (Lá»—i dá»¯ liá»‡u)`; }
Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) { console.error(e); alert("Lá»—i: " + e.message); } finally { btn.innerHTML = oldText; btn.disabled = false; }
Â  Â  Â  Â  Â  Â  }, 50);Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  async function fetchRoute(lat1, lng1, lat2, lng2, profile) {
Â  Â  Â  Â  Â  Â  let infoBox = document.getElementById('route-info');
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 2000));
Â  Â  Â  Â  Â  Â  Â  Â  const fetchPromise = fetch(`https://router.project-osrm.org/route/v1/${profile}/${lng1},${lat1};${lng2},${lat2}?overview=false`);
Â  Â  Â  Â  Â  Â  Â  Â  const res = await Promise.race([fetchPromise, timeout]);
Â  Â  Â  Â  Â  Â  Â  Â  if(!res.ok) throw new Error('Error');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  if(data.routes && data.routes.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let route = data.routes[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let distKm = (route.distance / 1000).toFixed(1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let durationMin = Math.round(route.duration / 60);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let icon = profile === 'driving' ? '<i class="fas fa-motorcycle"></i>' : '<i class="fas fa-walking"></i>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let type = profile === 'driving' ? '' : '(Äi bá»™)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  infoBox.innerHTML = `<div>${icon} <b>${distKm} km</b> - â±ï¸ <b>${durationMin} phÃºt</b> ${type}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return false;Â 
Â  Â  Â  Â  Â  Â  } catch(e) { return false; }
Â  Â  Â  Â  }

Â  Â  Â  Â  window.toggleFaultBox = function() {
Â  Â  Â  Â  Â  Â  let box = document.getElementById('fault-info-box');
Â  Â  Â  Â  Â  Â  box.classList.toggle('minimized');
Â  Â  Â  Â  Â  Â  let icon = box.querySelector('.toggle-icon');
Â  Â  Â  Â  Â  Â  if(box.classList.contains('minimized')) { icon.classList.remove('fa-minus'); icon.classList.add('fa-plus'); }Â 
Â  Â  Â  Â  Â  Â  else { icon.classList.remove('fa-plus'); icon.classList.add('fa-minus'); }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  window.closeFaultBox = function() { document.getElementById('fault-info-box').style.display = 'none'; }

Â  Â  Â  Â  window.captureInfo = function() {
Â  Â  Â  Â  Â  Â  let box = document.getElementById('fault-info-box');
Â  Â  Â  Â  Â  Â  box.classList.remove('minimized');
Â  Â  Â  Â  Â  Â  let btns = box.querySelector('.header-actions');
Â  Â  Â  Â  Â  Â  btns.style.display = 'none';
Â  Â  Â  Â  Â  Â  html2canvas(box, { backgroundColor: '#ffffff', scale: 2, useCORS: true }).then(canvas => {
Â  Â  Â  Â  Â  Â  Â  Â  btns.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  let link = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  link.download = 'bao_cao_su_co.png';
Â  Â  Â  Â  Â  Â  Â  Â  link.href = canvas.toDataURL();
Â  Â  Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  }).catch(err => {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Lá»—i chá»¥p áº£nh: " + err.message);
Â  Â  Â  Â  Â  Â  Â  Â  btns.style.display = 'flex';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  async function fetchAddress(lat, lng) {
Â  Â  Â  Â  Â  Â  const el = document.getElementById('fi-addr-text');
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(url);
Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  if(data && data.address) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let a = data.address; let parts = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(a.house_number) parts.push(a.house_number);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(a.road) parts.push(a.road);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let ward = a.quarter || a.village || a.neighbourhood || a.hamlet;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(ward) parts.push(ward); else if(a.suburb) parts.push(a.suburb);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let district = a.city_district || a.district || a.county;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(district) parts.push(district);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let city = a.city || a.state;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(city) parts.push(city);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let fullAddr = parts.length > 0 ? parts.join(", ") : "KhÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»¥ thá»ƒ";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.innerText = fullAddr;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch(e) { el.innerText = "KhÃ´ng láº¥y Ä‘Æ°á»£c Ä‘á»‹a chá»‰"; }
Â  Â  Â  Â  }

Â  Â  Â  Â  function getWindDirection(degrees) {
Â  Â  Â  Â  Â  Â  const directions = ['Báº¯c', 'ÄÃ´ng Báº¯c', 'ÄÃ´ng', 'ÄÃ´ng Nam', 'Nam', 'TÃ¢y Nam', 'TÃ¢y', 'TÃ¢y Báº¯c'];
Â  Â  Â  Â  Â  Â  const index = Math.round(degrees / 45) % 8;
Â  Â  Â  Â  Â  Â  return directions[index];
Â  Â  Â  Â  }

Â  Â  Â  Â  async function fetchWeather(lat, lng, incidentTime) {
Â  Â  Â  Â  Â  Â  let infoBox = document.getElementById('fault-weather');
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=temperature_2m,precipitation,weather_code,wind_speed_10m,wind_direction_10m&timezone=auto&past_days=1`;
Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(url);
Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  if (data.hourly) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let targetTime = new Date(incidentTime);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let times = data.hourly.time.map(t => new Date(t));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let index = -1; let minDiff = Infinity;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(let i=0; i<times.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let diff = Math.abs(times[i] - targetTime);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(diff < minDiff) { minDiff = diff; index = i; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(index !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let code = data.hourly.weather_code[index];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let isStorm = [95, 96, 99].includes(code);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let rain = data.hourly.precipitation[index];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let windSpd = data.hourly.wind_speed_10m[index];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let windDeg = data.hourly.wind_direction_10m[index];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let temp = data.hourly.temperature_2m[index];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let hour = targetTime.getHours();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let isNight = hour < 6 || hour > 18;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let condition = "Náº¯ng/Ãt mÃ¢y";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(isNight) condition = "Quang mÃ¢y/CÃ³ sao";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(code > 3) condition = "Nhiá»u mÃ¢y";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(code >= 51) condition = "MÆ°a";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(isStorm) condition = "DÃ´ng sÃ©t";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let iconRotation = windDeg + 180;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let html = `<div class="weather-row"><span><i class="fas fa-wind"></i> GiÃ³:</span> <div style="display:flex;align-items:center;gap:8px;"><b>${windSpd} km/h</b><div style="border:1px solid #999; border-radius:50%; width:24px; height:24px; display:flex; justify-content:center; align-items:center; background:white;"><i class="fas fa-arrow-up" style="transform: rotate(${iconRotation}deg); color:#333; font-size:14px;"></i></div></div></div><div class="weather-row"><span><i class="fas fa-cloud"></i> Trá»i:</span> <b>${condition}</b></div><div class="weather-row"><span><i class="fas fa-temperature-high"></i> Nhiá»‡t Ä‘á»™:</span> <b>${temp}Â°C</b></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(rain > 2.0) html += `<div class="weather-alert" style="color:orange;border-color:orange"><i class="fas fa-cloud-rain"></i> MÆ°a: ${rain}mm - ÄÆ°á»ng trÆ¡n</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(rain > 10.0) html += `<div class="weather-flood"><i class="fas fa-water"></i> NGUY CÆ  NGáº¬P CAO!</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(isStorm) html += `<div class="weather-alert"><i class="fas fa-bolt"></i> Cáº¢NH BÃO: CÃ“ DÃ”NG SÃ‰T!</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  infoBox.innerHTML = html;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else { infoBox.innerHTML = "KhÃ´ng cÃ³ dá»¯ liá»‡u thá»i tiáº¿t."; }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (e) { infoBox.innerHTML = 'Lá»—i láº¥y thá»i tiáº¿t.'; }
Â  Â  Â  Â  }

Â  Â  Â  Â  window.confirmAction = function() {
Â  Â  Â  Â  Â  Â  if (!window.pendingAction) { closeWinDialog(); return; }
Â  Â  Â  Â  Â  Â  if (window.pendingAction.type === 'mc') { window.update(window.ref(window.db, 'he_thong_luoi_dien/mcStates'), { [window.pendingAction.name]: !(appData.mcStates[window.pendingAction.name] !== false) }); }
Â  Â  Â  Â  Â  Â  closeWinDialog();
Â  Â  Â  Â  }
Â  Â  Â  Â  window.closeWinDialog = function() { document.getElementById('custom-confirm').style.display = 'none'; window.pendingAction = null; }
Â  Â  Â  Â  window.toggleGrounding = function() { let cid = document.getElementById('circuitSelect').value; if(!cid) return; let currentG = appData.grounded ? appData.grounded[cid] : false; window.update(window.ref(window.db, 'he_thong_luoi_dien/grounded'), { [cid]: !currentG }); }

Â  Â  Â  Â  var legendControl = L.control({position: 'bottomright'});
Â  Â  Â  Â  legendControl.onAdd = function (map) { var div = L.DomUtil.create('div', 'legend'); div.innerHTML = `<div class="legend-item"><span class="legend-icon" style="background:#ff0000;"></span> ÄÃ³ng (Äá»)</div><div class="legend-item"><span class="legend-icon" style="background:#388e3c;"></span> Cáº¯t (Xanh)</div>`; return div; };
Â  Â  Â  Â  legendControl.addTo(map);

Â  Â  Â  Â  var faultControl = L.control({position: 'bottomright'});
Â  Â  Â  Â  faultControl.onAdd = function (map) {Â 
Â  Â  Â  Â  Â  Â  var div = L.DomUtil.create('div', 'fault-box');Â 
Â  Â  Â  Â  Â  Â  div.id = "fault-info-box";Â 
Â  Â  Â  Â  Â  Â  div.setAttribute('style', 'display:none');Â 
Â  Â  Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="fault-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span><i class="fas fa-exclamation-triangle"></i> Sá»° Cá»</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="header-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="header-btn" onclick="captureInfo()" title="Chá»¥p bÃ¡o cÃ¡o"><i class="fas fa-camera"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="header-btn" onclick="toggleFaultBox()" title="Thu nhá»"><i class="fas fa-minus toggle-icon"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="header-btn" onclick="closeFaultBox()" title="ÄÃ³ng">X</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="fault-body">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="route-info" class="route-info-box" style="display:none"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="fault-text-block" id="fi-text-content">---</div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="fault-row"><span class="fault-label">Äá»‹a chá»‰:</span> <span id="fi-addr-text">---</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="fault-row"><span class="fault-label">Map:</span> <span id="fi-addr"><a id="fi-map-link" href="#" target="_blank">Má»Ÿ Google Maps</a></span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="fault-weather" class="weather-info" style="display:none"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;Â 
Â  Â  Â  Â  Â  Â  return div;Â 
Â  Â  Â  Â  };
Â  Â  Â  Â  faultControl.addTo(map);

Â  Â  </script>
</body>
</html>
